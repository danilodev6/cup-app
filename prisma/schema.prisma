generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       Int       @id @default(autoincrement())
  username String    @unique
  password String    // bcrypt hash
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())
}

model Tournament {
  id           Int            @id @default(autoincrement())
  name         String         @unique
  location     String
  date         DateTime
  teamCount    Int
  teams        Team[]
  groupMatches GroupMatch[]
  koTies       KnockoutTie[]
  matchEvents  MatchEvent[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt @default(now())
}

model Team {
  id            Int           @id @default(autoincrement())
  name          String        @unique
  shortName     String
  logoUrl       String
  players       Player[]
  group         String?
  tournamentId  Int
  tournament    Tournament    @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  teamScore     Int           @default(0)

  // relations for group matches
  homeGroupMatches   GroupMatch[]    @relation("HomeTeam")
  awayGroupMatches   GroupMatch[]    @relation("AwayTeam")

  // relations for knockout ties
  homeTies           KnockoutTie[]   @relation("HomeTie")
  awayTies           KnockoutTie[]   @relation("AwayTie")

  // relations for knockout legs individually
  homeKoLegs         KnockoutLeg[]   @relation("HomeTeam")
  awayKoLegs         KnockoutLeg[]   @relation("AwayTeam")

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt @default(now())
}

model Player {
  id          Int           @id @default(autoincrement())
  name        String
  photoUrl    String
  teamId      Int
  team        Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  matchEvents MatchEvent[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt @default(now())
}

// GroupMatch (group matches)
model GroupMatch {
  id            Int          @id @default(autoincrement())
  date          DateTime
  tournamentId  Int
  tournament    Tournament   @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  homeTeamId    Int
  homeTeam      Team         @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeamId    Int
  awayTeam      Team         @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
  homeScore     Int          @default(0)
  awayScore     Int          @default(0)
  isFinished    Boolean      @default(false)
  matchEvents   MatchEvent[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt @default(now())
}

// KnockoutTie (tie completo de un partido de knockout)
model KnockoutTie {
  id            Int           @id @default(autoincrement())
  tournamentId  Int
  tournament    Tournament    @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  koPosition    Int           // 1-16 (posición en el bracket)
  format        String        @default("two-leg") // "single-leg" | "two-leg"
  
  // the teams of the tie (don't change between legs)
  homeTeamId    Int
  homeTeam      Team          @relation("HomeTie", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeamId    Int
  awayTeam      Team          @relation("AwayTie", fields: [awayTeamId], references: [id], onDelete: Cascade)
  
  // two legs of this tie
  legs          KnockoutLeg[]
  
  // aggregated tie state
  isFinished    Boolean       @default(false)
  winnerId      Int?          // ID del equipo ganador después de ambos legs
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt @default(now())
  
  @@unique([tournamentId, koPosition])
}

// KnockoutLeg (leg individual de un tie)
model KnockoutLeg {
  id            Int           @id @default(autoincrement())
  
  tieId         Int
  tie           KnockoutTie   @relation(fields: [tieId], references: [id], onDelete: Cascade)
  
  legNumber     Int           // 1 o 2
  date          DateTime
  
  // In the leg 1: homeTeam of the tie plays at home
  // In the leg 2: awayTeam of the tie plays at home (reversed)
  homeTeamId    Int
  homeTeam      Team          @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeamId    Int
  awayTeam      Team          @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
  
  homeScore     Int           @default(0)
  awayScore     Int           @default(0)
  isFinished    Boolean       @default(false)
  
  matchEvents   MatchEvent[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt @default(now())
  
  @@unique([tieId, legNumber])
}

model MatchEvent {
  id                Int          @id @default(autoincrement())
  tournamentId      Int
  tournament        Tournament   @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  
  // relation with group match
  groupMatchId      Int?
  groupMatch        GroupMatch?  @relation(fields: [groupMatchId], references: [id], onDelete: Cascade)
  
  // relation with knockout leg
  knockoutLegId     Int?
  knockoutLeg       KnockoutLeg? @relation(fields: [knockoutLegId], references: [id], onDelete: Cascade)
  
  playerId          Int
  player            Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  eventType         String       // "goal", "yellow_card", "red_card"
  createdAt         DateTime     @default(now())
}
