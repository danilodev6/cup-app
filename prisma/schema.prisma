generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       Int       @id @default(autoincrement())
  username String    @unique
  password String    // bcrypt hash
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())
}

model Tournament {
  id           Int            @id @default(autoincrement())
  name         String         @unique
  location     String
  date         DateTime
  teamCount    Int
  teams        Team[]
  groupMatches GroupMatch[]   // Renombrado de 'matches'
  koTies       KnockoutTie[]
  matchEvents  MatchEvent[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt @default(now())
}

model Team {
  id            Int           @id @default(autoincrement())
  name          String        @unique
  shortName     String     
  logoUrl       String
  players       Player[]
  group         String?
  tournamentId  Int
  tournament    Tournament    @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  teamScore     Int           @default(0)

  // Relaciones para partidos de grupo
  homeGroupMatches   GroupMatch[]    @relation("HomeTeam")
  awayGroupMatches   GroupMatch[]    @relation("AwayTeam")

  // Relaciones para knockout ties
  homeTies           KnockoutTie[]   @relation("HomeTie")
  awayTies           KnockoutTie[]   @relation("AwayTie")

  // Relaciones para knockout legs individuales
  homeKoLegs         KnockoutLeg[]   @relation("HomeTeam")
  awayKoLegs         KnockoutLeg[]   @relation("AwayTeam")

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt @default(now())
}

model Player {
  id          Int           @id @default(autoincrement())
  name        String
  photoUrl    String
  teamId      Int
  team        Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  matchEvents MatchEvent[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt @default(now())
}

// RENOMBRADO: Match → GroupMatch (partidos de fase de grupos)
model GroupMatch {
  id            Int          @id @default(autoincrement())
  date          DateTime
  tournamentId  Int
  tournament    Tournament   @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  homeTeamId    Int
  homeTeam      Team         @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeamId    Int
  awayTeam      Team         @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
  homeScore     Int          @default(0)
  awayScore     Int          @default(0)
  isFinished    Boolean      @default(false)
  matchEvents   MatchEvent[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt @default(now())
}

// Modelo que representa el "tie" completo (enfrentamiento de dos partidos)
model KnockoutTie {
  id            Int           @id @default(autoincrement())
  tournamentId  Int
  tournament    Tournament    @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  koPosition    Int           // 1-16 (posición en el bracket)
  
  // Los equipos del tie (no cambian entre legs)
  homeTeamId    Int
  homeTeam      Team          @relation("HomeTie", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeamId    Int
  awayTeam      Team          @relation("AwayTie", fields: [awayTeamId], references: [id], onDelete: Cascade)
  
  // Los dos legs de este tie
  legs          KnockoutLeg[]
  
  // Estado agregado del tie
  isFinished    Boolean       @default(false)
  winnerId      Int?          // ID del equipo ganador después de ambos legs
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt @default(now())
  
  @@unique([tournamentId, koPosition])
}

// Modelo que representa cada leg individual
model KnockoutLeg {
  id            Int           @id @default(autoincrement())
  
  tieId         Int
  tie           KnockoutTie   @relation(fields: [tieId], references: [id], onDelete: Cascade)
  
  legNumber     Int           // 1 o 2
  date          DateTime
  
  // En el leg 1: homeTeam del tie juega en casa
  // En el leg 2: awayTeam del tie juega en casa (se invierten)
  homeTeamId    Int
  homeTeam      Team          @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeamId    Int
  awayTeam      Team          @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
  
  homeScore     Int           @default(0)
  awayScore     Int           @default(0)
  isFinished    Boolean       @default(false)
  
  matchEvents   MatchEvent[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt @default(now())
  
  @@unique([tieId, legNumber])
}

model MatchEvent {
  id                Int          @id @default(autoincrement())
  tournamentId      Int
  tournament        Tournament   @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  
  // Relación con partido de grupo
  groupMatchId      Int?
  groupMatch        GroupMatch?  @relation(fields: [groupMatchId], references: [id], onDelete: Cascade)
  
  // Relación con leg de knockout
  knockoutLegId     Int?
  knockoutLeg       KnockoutLeg? @relation(fields: [knockoutLegId], references: [id], onDelete: Cascade)
  
  playerId          Int
  player            Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  eventType         String       // "goal", "yellow_card", "red_card"
  createdAt         DateTime     @default(now())
}
