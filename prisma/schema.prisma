generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())
}

model Tournament {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  location  String
  date      DateTime
  teamCount Int
  teams     Team[]
  matches   Match[]
  koMatches  KnockoutMatch[]
  matchEvents MatchEvent[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())
}

model Team {
  id            Int        @id @default(autoincrement())
  name          String     @unique
  shortName     String     
  logoUrl       String
  players       Player[]
  group         String?
  tournamentId  Int
  tournament    Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  teamScore     Int        @default(0)

  // Relaciones para matches
  homeMatches   Match[]    @relation("HomeTeam")
  awayMatches   Match[]    @relation("AwayTeam")

  // Relaciones para ko
  homeKoMatches   KnockoutMatch[]    @relation("HomeTeam")
  awayKoMatches   KnockoutMatch[]    @relation("AwayTeam")


  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt @default(now())
}

model Player {
  id        Int      @id @default(autoincrement())
  name      String
  photoUrl  String
  teamId    Int
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  matchEvents MatchEvent[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())
}

model Match {
    id            Int      @id @default(autoincrement())
    date          DateTime
    tournamentId  Int
    tournament    Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
    homeTeamId    Int
    homeTeam      Team     @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
    awayTeamId    Int
    awayTeam      Team     @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
    homeScore     Int      @default(0)
    awayScore     Int      @default(0)
    isFinished    Boolean  @default(false)
    matchEvents   MatchEvent[]
    createdAt     DateTime   @default(now())
    updatedAt     DateTime   @updatedAt @default(now())

}

model KnockoutMatch {
  id            Int        @id @default(autoincrement())
  date          DateTime
  tournamentId  Int
  tournament    Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  koPosition    Int        // 1-16
  homeTeamId    Int        // shortName of the home team
  homeTeam      Team       @relation("HomeTeam", fields: [homeTeamId], references: [id], onDelete: Cascade)
  awayTeamId    Int        // shortName of the away team
  awayTeam      Team       @relation("AwayTeam", fields: [awayTeamId], references: [id], onDelete: Cascade)
  homeScore     Int        @default(0)
  awayScore     Int        @default(0)
  isFinished    Boolean    @default(false)
  matchEvents   MatchEvent[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt @default(now())
  @@unique([tournamentId, koPosition]) 
}

model MatchEvent {
  id                Int              @id @default(autoincrement())
  tournamentId      Int
  tournament        Tournament       @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matchId           Int?
  match             Match?           @relation(fields: [matchId], references: [id], onDelete: Cascade)
  knockoutMatchId   Int?
  knockoutMatch     KnockoutMatch?   @relation(fields: [knockoutMatchId], references: [id], onDelete: Cascade)
  playerId          Int
  player            Player           @relation(fields: [playerId], references: [id], onDelete: Cascade)
  eventType         String           // "goal", "yellow_card", "red_card"
  createdAt         DateTime         @default(now())
}
